version: 0.2
phases:
  install:
    commands:
    - |
      export DEBIAN_FRONTEND=noninteractive
      export ENV COMPOSER_ALLOW_SUPERUSER 1

      #Install php7.2
      apt-get update --fix-missing && \
      apt-get install -y --no-install-recommends apt-utils gnupg && \
      apt-get -y install locales locales-all unzip vim cron procps && \
      locale-gen en_US.UTF-8 && \
      update-locale

      export LANG=en_US.UTF-8
      export LANGUAGE=en_US:en
      export LC_ALL=en_US.UTF-8

      apt-get install -y --no-install-recommends apt-transport-https lsb-release ca-certificates wget && \
      wget -O /etc/apt/trusted.gpg.d/php.gpg https://packages.sury.org/php/apt.gpg && \
      echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/php.list && \
      apt-get update && \
      apt-get -y upgrade

      # Install PHP
      apt-get -y install php7.2-fpm php7.2-curl php7.2-mbstring php7.2-intl php7.2-bcmath php7.2-xmlrpc php7.2-xml php7.2-zip php7.2-mysql

#      #Enable xdebug - phpunit uses this for code coverage
#      phpenmod xdebug

      #Install composer
      curl -sS https://getcomposer.org/installer | php -- && \
      php composer.phar config -g repos.packagist composer https://packagist.jp && \
      php composer.phar global require hirak/prestissimo

      #Various handy node based dev tools - do you need these during your build? Comment if not.
      # npm install -g yarn
      # yarn install

    # Start Mysql if you need it
    # - apt-get install -y mysql-server
    # - su mysql -s /bin/bash -c "/usr/sbin/mysqld" &
  build:
    commands:
    - echo Build started on `date`
    - echo Installing composer deps
    - composer install --no-progress --no-suggest

  post_build:
    commands:
    - echo Build completed on `date`
    # Do you need to do this? In many cases phpunit will use sqllite or similar to avoid the need for a real DB.
    # If you don't need it delete it
    # - /usr/bin/mysql  -u root -e "GRANT ALL ON *.* TO 'test'@'localhost' IDENTIFIED BY '' WITH GRANT OPTION"
    # - mysqladmin -u test create test
    - ./vendor/bin/phpunit